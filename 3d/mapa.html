<!DOCTYPE html>
<html>
  <head>
    <title>Ruta de Barco 3D</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      gmp-map-3d {
        height: 100%;
        width: 100%;
        position: absolute;
      }
      #menu {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 300px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        padding: 15px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        z-index: 1;
      }
      .barco-info {
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .barco-info:hover {
        background-color: #f5f5f5;
      }
      .barco-info.selected {
        background-color: #e0e0e0;
      }
      .barco-info h3 {
        margin: 0 0 10px 0;
      }
      .barco-info p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      .filter {
        margin-bottom: 10px;
      }
      .results-count {
        margin-top: 10px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <gmp-map-3d center="43.3,-2.9" range="2000" tilt="45" heading="0">
      <!-- Las polilíneas y marcadores se agregarán aquí dinámicamente -->
    </gmp-map-3d>
    
    <div id="menu">
      <div class="filter">
        <label for="origen">Origen:</label>
        <input type="text" id="origen">
      </div>
      <div class="filter">
        <label for="destino">Destino:</label>
        <input type="text" id="destino">
      </div>
      <div class="filter">
        <label for="fechaSalida">Fecha de Salida:</label>
        <input type="date" id="fechaSalida">
      </div>
      <div class="filter">
        <label for="fechaLlegada">Fecha de Llegada:</label>
        <input type="date" id="fechaLlegada">
      </div>
      <div class="filter">
        <label for="tipo">Tipo:</label>
        <input type="text" id="tipo">
      </div>
      <button onclick="aplicarFiltros()">Filtrar</button>
      <div id="resultsCount" class="results-count"></div>
    </div>

    <script async src="https://maps.googleapis.com/maps/api/js?key=(TUAPIKEYVAAQUI)&v=alpha&libraries=maps3d"></script>
    <script>
      let rutasBarcos = [];
      let rutasBarcosOriginal = [];
      let polylines = [];
      let markers = [];
      let selectedBarco = null;

      function calcularDiferenciaTiempo(timestampInicio, timestampFin) {
        const inicio = new Date(timestampInicio.replace(" ", "T"));
        const fin = new Date(timestampFin.replace(" ", "T"));
        const diferenciaMs = fin - inicio;
        const diferenciaHoras = diferenciaMs / (1000 * 60 * 60);
        return diferenciaHoras.toFixed(1);
      }

      function limpiarMapa() {
        polylines.forEach(polyline => polyline.remove());
        markers.forEach(marker => marker.remove());
        polylines = [];
        markers = [];
      }

      function dibujarRutas() {
        limpiarMapa();
        const map = document.querySelector('gmp-map-3d');

        rutasBarcos.forEach((barco, index) => {
          // Crear el elemento polilínea
          const polyline = document.createElement('gmp-polyline-3d');
          polyline.setAttribute('altitude-mode', 'clamp-to-ground');
          polyline.setAttribute('stroke-color', barco.color || '#FF0000');
          polyline.setAttribute('stroke-width', selectedBarco === null || selectedBarco === index ? '4' : '2');
          polyline.setAttribute('stroke-opacity', selectedBarco === null || selectedBarco === index ? '1.0' : '0.3');
          
          // Agregar la polilínea al mapa
          map.appendChild(polyline);
          polylines.push(polyline);

          // Configurar las coordenadas cuando el elemento esté definido
          customElements.whenDefined(polyline.localName).then(() => {
            // Convertir los puntos de la ruta al formato correcto
            polyline.coordinates = barco.ruta.map(punto => ({
              lat: parseFloat(punto.lat),
              lng: parseFloat(punto.lng)
            }));
          });

          // Agregar marcadores de inicio y fin
          const markerInicio = document.createElement('gmp-marker-3d');
          markerInicio.position = {
            lat: parseFloat(barco.ruta[0].lat),
            lng: parseFloat(barco.ruta[0].lng)
          };
          markerInicio.title = `Inicio - ${barco.nombre}\n${barco.ruta[0].timestamp}`;
          map.appendChild(markerInicio);
          markers.push(markerInicio);

          const markerFin = document.createElement('gmp-marker-3d');
          markerFin.position = {
            lat: parseFloat(barco.ruta[barco.ruta.length - 1].lat),
            lng: parseFloat(barco.ruta[barco.ruta.length - 1].lng)
          };
          markerFin.title = `Fin - ${barco.nombre}\n${barco.ruta[barco.ruta.length - 1].timestamp}`;
          map.appendChild(markerFin);
          markers.push(markerFin);

          // Agregar evento de clic para la polilínea
          polyline.addEventListener('click', () => {
            seleccionarBarco(index, false);
          });
        });
      }

    function calcularDistancia(ruta) {
      if (!ruta || ruta.length < 2) return 0;
      let distanciaTotal = 0;
      for (let i = 1; i < ruta.length; i++) {
        const lat1 = parseFloat(ruta[i - 1].lat);
        const lon1 = parseFloat(ruta[i - 1].lng);
        const lat2 = parseFloat(ruta[i].lat);
        const lon2 = parseFloat(ruta[i].lng);
        
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
        0.5 - Math.cos(dLat)/2 + 
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        (1 - Math.cos(dLon))/2;
        distanciaTotal += R * 2 * Math.asin(Math.sqrt(a));
      }
      return distanciaTotal.toFixed(2);
    }

      function crearMenu() {
        mostrarRutasFiltradas(rutasBarcos);
      }

      function aplicarFiltros() {
        const origen = document.getElementById('origen').value.toLowerCase();
        const destino = document.getElementById('destino').value.toLowerCase();
        const fechaSalida = document.getElementById('fechaSalida').value;
        const fechaLlegada = document.getElementById('fechaLlegada').value;
        const tipo = document.getElementById('tipo').value.toLowerCase();

        const rutasFiltradas = rutasBarcosOriginal.filter((barco) => {
          const fechaSalidaBarco = barco.ruta[0].timestamp.split(" ")[0];
          const fechaLlegadaBarco = barco.ruta[barco.ruta.length - 1].timestamp.split(" ")[0];
          return (!origen || barco.origen.toLowerCase().includes(origen)) &&
                 (!destino || barco.destino.toLowerCase().includes(destino)) &&
                 (!fechaSalida || fechaSalidaBarco === fechaSalida) &&
                 (!fechaLlegada || fechaLlegadaBarco === fechaLlegada) &&
                 (!tipo || barco.tipo.toLowerCase().includes(tipo));
        });

        mostrarRutasFiltradas(rutasFiltradas);
      }

      function dibujarZonasPirateria() {
        const map = document.querySelector('gmp-map-3d');
        const polygon = document.createElement('gmp-polygon-3d');
        
        // Establecer atributos de estilo
        polygon.setAttribute('altitude-mode', 'clamp-to-ground');
        polygon.setAttribute('fill-color', 'rgba(255, 0, 0, 0.2)'); // Rojo semitransparente
        polygon.setAttribute('stroke-color', 'rgba(255, 0, 0, 0.8)');
        polygon.setAttribute('stroke-width', '2');
        polygon.setAttribute('draws-occluded-segments', '');
        
        // Agregar el polígono al mapa
        map.appendChild(polygon);

        //Pirateria SE Asia
        customElements.whenDefined(polygon.localName).then(() => {
          polygon.outerCoordinates = [
            { lat: 5.94881891566034, lng: 77.56485517528137 },
            { lat: 15.663815271835254, lng: 80.37757659352306 },
            { lat: 22.774225045521586, lng: 87.57668209998187 },
            { lat: 23.08337468591659, lng: 128.09085153698783 },
            { lat: -2.275348825395962, lng: 141.41700234977682 },
            { lat: -10.362182954616511, lng: 140.2123884501309 },
            { lat: -10.622676815410962, lng: 97.13974210388274 }
          ];
        });
        
        //Pirateria Este Africa
        const polygon2 = document.createElement('gmp-polygon-3d');
        polygon2.setAttribute('altitude-mode', 'clamp-to-ground');
        polygon2.setAttribute('fill-color', 'rgba(255, 0, 0, 0.2)'); // Rojo semitransparente
        polygon2.setAttribute('stroke-color', 'rgba(255, 0, 0, 0.8)');
        polygon2.setAttribute('stroke-width', '2');
        polygon2.setAttribute('draws-occluded-segments', '');

        map.appendChild(polygon2);
        customElements.whenDefined(polygon2.localName).then(() => {
          polygon2.outerCoordinates = [
            {lat: -15.343187861699136, lng: 40.680277934323634 },
            { lat: -3.845320774349314, lng: 38.583560112626024 },
            { lat: 14.46666727466379, lng: 42.627229952896954 },
            { lat: 18.344833061098907, lng: 59.50081623227303 },
            { lat: -1.551615488891703, lng: 63.49456446407802 },
            { lat: -5.834972454400742, lng: 45.97199409703362}
          ]
        })

        //Pirateria Oeste Africa
        const polygon3 = document.createElement('gmp-polygon-3d');
        polygon3.setAttribute('altitude-mode', 'clamp-to-ground');
        polygon3.setAttribute('fill-color', 'rgba(255, 0, 0, 0.2)'); // Rojo semitransparente
        polygon3.setAttribute('stroke-color', 'rgba(255, 0, 0, 0.8)');
        polygon3.setAttribute('stroke-width', '2');
        polygon3.setAttribute('draws-occluded-segments', '');

        map.appendChild(polygon3);
        customElements.whenDefined(polygon3.localName).then(() => {
          polygon3.outerCoordinates = [
            { lat: -14.401273484974325, lng: 13.486101906428722 },
            { lat: -8.833789443317498, lng: 14.730766524691832},
            { lat: 7.345143926663417, lng: 9.052702791770013 },
            { lat: 13.642727073380177, lng: -16.6054820527249 },
            { lat: 13.17898402027279, lng: -21.648222004917343 },
            { lat: -0.03136480823953766, lng: -12.667559195918011 },
            { lat: -2.539926176659846, lng: 3.2387571704465086 },
            { lat: -13.411706639811825, lng: 4.038127048649852}
          ]
        })

        //Pirateria Centro America
        const polygon4 = document.createElement('gmp-polygon-3d');
        polygon4.setAttribute('altitude-mode', 'clamp-to-ground');
        polygon4.setAttribute('fill-color', 'rgba(255, 0, 0, 0.2)'); // Rojo semitransparente
        polygon4.setAttribute('stroke-color', 'rgba(255, 0, 0, 0.8)');
        polygon4.setAttribute('stroke-width', '2');
        polygon4.setAttribute('draws-occluded-segments', '');

        map.appendChild(polygon4);
        customElements.whenDefined(polygon4.localName).then(() => {
          polygon4.outerCoordinates = [
            { lat: -12.200437764191836, lng: -77.20090814928504 },
            { lat: 14.896084093095714, lng: -95.49519587988962 },
            { lat: 22.667476370399342, lng: -92.1763207626869 },
            { lat: 22.779473803415428, lng: -74.08440396525248 },
            { lat: 12.89241694398438, lng: -61.375539010800814 },
            { lat: 5.74808074671773, lng: -49.111890711868774 },
            { lat: 3.5294380668728556, lng: -51.49986183278294 },
            { lat: 8.598944108262874, lng: -72.2630683586976 },
            { lat: -5.1632544642111675, lng: -78.73892269243805 }
          ]
        })

      }

      function mostrarRutasFiltradas(rutas) {
        const menu = document.getElementById('menu');
        const origen = document.getElementById('origen')?.value || '';
        const destino = document.getElementById('destino')?.value || '';
        const fechaSalida = document.getElementById('fechaSalida')?.value || '';
        const fechaLlegada = document.getElementById('fechaLlegada')?.value || '';
        const tipo = document.getElementById('tipo')?.value || '';

        menu.innerHTML = `
          <div class="filter">
            <label for="origen">Origen:</label>
            <input type="text" id="origen" value="${origen}">
          </div>
          <div class="filter">
            <label for="destino">Destino:</label>
            <input type="text" id="destino" value="${destino}">
          </div>
          <div class="filter">
            <label for="fechaSalida">Fecha de Salida:</label>
            <input type="date" id="fechaSalida" value="${fechaSalida}">
          </div>
          <div class="filter">
            <label for="fechaLlegada">Fecha de Llegada:</label>
            <input type="date" id="fechaLlegada" value="${fechaLlegada}">
          </div>
          <div class="filter">
            <label for="tipo">Tipo:</label>
            <input type="text" id="tipo" value="${tipo}">
          </div>
          <button onclick="aplicarFiltros()">Filtrar</button>
          <div id="resultsCount" class="results-count">Hay ${rutas.length} resultados</div>
        `;

        if (rutas.length === 0) {
          limpiarMapa();
        } else {
          rutasBarcos = rutas;
          rutas.forEach((barco, index) => {
            const distancia = calcularDistancia(barco.ruta); // Uso geodesica en vez de DistanceMatrix, menos consumo de API y carga más rápida
            const barcoInfo = document.createElement('div');
            barcoInfo.className = `barco-info ${selectedBarco === index ? 'selected' : ''}`;
            
            const flagOffset = 0x1F1E6;
            const asciiOffset = 0x41;
            const firstChar = String.fromCodePoint(barco.pabellon.charCodeAt(0) - asciiOffset + flagOffset);
            const secondChar = String.fromCodePoint(barco.pabellon.charCodeAt(1) - asciiOffset + flagOffset);
            const flag = firstChar + secondChar;

            barcoInfo.innerHTML = `
              <h3>${flag} ${barco.nombre}</h3>
              <p><strong>Origen:</strong> ${barco.origen}</p>
              <p><strong>Destino:</strong> ${barco.destino}</p>
              <p><strong>Fecha de Salida:</strong> ${barco.ruta[0].timestamp}</p>
              <p><strong>Fecha de Llegada:</strong> ${barco.ruta[barco.ruta.length - 1].timestamp}</p>
              <p><strong>Diferencia de Tiempo:</strong> ${calcularDiferenciaTiempo(barco.ruta[0].timestamp, barco.ruta[barco.ruta.length - 1].timestamp)}h</p>
              <p><strong>Distancia Total:</strong> ${distancia} km</p>
              <p><strong>Tipo:</strong> ${barco.tipo}</p>
            `;
            barcoInfo.onclick = () => seleccionarBarco(index, true);
            menu.appendChild(barcoInfo);
          });

          dibujarRutas();
        }
      }

      function seleccionarBarco(index, fromMenu) {
        selectedBarco = selectedBarco === index ? null : index;
        dibujarRutas();
        if (!fromMenu) {
          mostrarRutasFiltradas(rutasBarcos);
        }
      }

      // Cargar datos cuando se inicie la página
      window.onload = function() {
        const storedData = localStorage.getItem('rutasBarcos');
        if (storedData) {
          rutasBarcos = JSON.parse(storedData).barcos;
          rutasBarcosOriginal = JSON.parse(storedData).barcos;
          console.log('Rutas de barcos cargadas:', rutasBarcos);
          dibujarRutas();
          crearMenu();
          dibujarZonasPirateria();
        } else {
          console.error('No se encontraron datos en localStorage');
        }
      };
    </script>
  </body>
</html>